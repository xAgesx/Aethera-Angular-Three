
<!-- Notification Area -->

<div class="notification-container" *ngIf="mainService.notification().type"
  [class.show]="mainService.notification().type">
  <div class="notification-popup" [ngClass]="mainService.notification().type">
    <div class="notification-icon">
      <svg *ngIf="mainService.notification().type === 'success'" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
      <svg *ngIf="mainService.notification().type === 'error'" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
    </div>
    <div class="notification-content">
      <p class="notification-message">{{ mainService.notification().message }}</p>
    </div>
    <button class="notification-close"
      (click)="mainService.notification.set({message: '', type: null})">&times;</button>
    <div class="notification-progress"></div>
  </div>
</div>


<div class="details-container" *ngIf="game">
  <!-- Back Button -->
  <button class="back-button" (click)="goBack()">
    <i class="fas fa-arrow-left"></i> Back to Browse
  </button>

  <!-- Game Header -->
  <header class="header-hero">
    <div class="header-info">
      <h1>{{ game.title }}</h1>
      <p class="short-desc">{{ game.description }}</p>

      <div class="stats-row">
        <span class="rating">
          <i class="fas fa-star"></i> {{ game.rating || 'N/A' }}
        </span>
        <span class="divider">|</span>
        <span class="players">
          <strong>{{ game.players || '0' }}</strong> Players
        </span>
      </div>
    </div>

    <div class="actions">
      <button class="like-btn" [class.liked]="game.liked" (click)="toggleLike()">
        <i class="fas fa-heart"></i> {{ game.liked ? 'Liked' : 'Like' }}
      </button>
      <button class="launch-button" (click)="loadGame()">
        <i class="fas fa-play"></i> Play Now
      </button>
    </div>
  </header>

  <div class="main-grid">
    <div class="main-content">
      <!-- Media Carousel -->
      <div class="media-carousel" *ngIf="game.images && game.images.length > 0">
        <img *ngFor="let img of game.images; let i = index" [src]="img" [class.active]="i === currentSlide"
          class="carousel-img">

        <button class="carousel-arrow left" (click)="changeSlide(-1)">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button class="carousel-arrow right" (click)="changeSlide(1)">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>

      <!-- Overview -->
      <div class="card overview-card">
        <h2>Overview</h2>
        <p>{{ game.longDescription || 'No additional details available.' }}</p>
      </div>

      <!-- Reviews Section -->
      <div class="card reviews-section">
        <h2>Community Reviews</h2>

        <div class="add-review" *ngIf="firebaseService.connectedUser">
          <div class="user-meta">
            <img
              [src]="firebaseService.connectedUser.profilePic || 'https://api.dicebear.com/7.x/avataaars/svg?seed=fallback'"
              class="mini-avatar">
            <span>Reviewing as <strong>{{ firebaseService.connectedUser.username }}</strong></span>
          </div>
          <div class="rating-input">
            <label>Rating: </label>
            <select [(ngModel)]="rating" class="styled-select">
              <option [value]="5">5 - Excellent</option>
              <option [value]="4">4 - Great</option>
              <option [value]="3">3 - Good</option>
              <option [value]="2">2 - Fair</option>
              <option [value]="1">1 - Poor</option>
            </select>
          </div>
          <textarea [(ngModel)]="newReviewContent" placeholder="Write your thoughts about the game..."></textarea>
          <button (click)="submitReview();" class="save-btn" [disabled]="!newReviewContent.trim()">Post Review</button>
        </div>

        <!-- Review List -->
        <div class="reviews-list">
          <div *ngFor="let rev of reviews$ | async" class="review-item">
            <div class="review-header">
              <div class="user-info">
                <img [src]="rev.photoURL || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + rev.username"
                  class="review-avatar">
                <span class="user">{{ rev.username }}</span>
              </div>
              <div class="header-right">
                <span class="stars">{{ rev.rating }} â˜…</span>
                <div class="action-btns" *ngIf="rev.userEmail === firebaseService.connectedUser?.email">
                  <button (click)="startEdit(rev)" class="edit-btn"><i class="fas fa-edit"></i>Edit</button>
                  <button (click)="deleteReview(rev.id!)" class="del-btn"><i class="fas fa-trash"></i>Delete</button>
                </div>
              </div>
            </div>

            <!-- Edit Mode -->
            <div class="review-body">
              <div *ngIf="editingReviewId === rev.id; else viewMode">
                <textarea [(ngModel)]="editContent" class="edit-area"></textarea>
                <div class="edit-actions">
                  <button (click)="saveEdit(rev.id!)" class="save-btn">Save</button>
                  <button (click)="cancelEdit()" class="cancel-btn">Cancel</button>
                </div>
              </div>
              <ng-template #viewMode>
                <p class="content">{{ rev.content }}</p>
              </ng-template>
            </div>

            <div class="review-footer">
              <span class="date">{{ rev.createdAt | date:'mediumDate' }}</span>
              <button class="upvote-btn" (click)="toggleUpvote(rev)"
                [class.voted]="rev.upvotes!.includes(firebaseService.connectedUser?.email || '')">
                <i class="fas fa-thumbs-up"></i> {{ rev.upvotes!.length || 0 }}
              </button>
            </div>
          </div>

          <div *ngIf="(reviews$ | async)?.length === 0" class="no-reviews">
            No reviews yet. Be the first to share your experience!
          </div>
        </div>
      </div>
    </div>

    <aside class="sidebar-content">
      <div class="card tags-card" *ngIf="game.tags.length">
        <h2>Game Tags</h2>
        <div class="tag-container">
          <span *ngFor="let tag of game.tags" class="tag">{{ tag }}</span>
        </div>
      </div>

      <div class="card info-card">
        <h2>Game Info</h2>
        <ul class="info-list">
          <li><span>Release:</span> <span>{{ game.release || 'N/A' }}</span></li>
          <li><span>Developer:</span> <span>{{ game.developer || 'Unknown' }}</span></li>
          <li><span>Duration:</span> <span>{{ game.duration || 'N/A' }}</span></li>
          <li><span>Complexity:</span> <span>{{ game.complexity || 'N/A' }}</span></li>
        </ul>
      </div>

      <div class="card community-score" *ngIf="game.topScore">
        <h2>Top Score</h2>
        <div class="score-display">
          <span class="points">{{ game.topScore }}</span>
          <span class="player">by {{ game.topPlayer || 'Elite User' }}</span>
        </div>
      </div>
    </aside>
  </div>
</div>